<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Verify OTP | M&M Kid's Wear</title>
    <link rel="stylesheet" href="auth.css">
    <link rel="stylesheet" href="verify-otp.css">
</head>

<body>

    <script>
        /* ================================
           STRICT SESSION CHECK
        ================================ */
        const rawData = sessionStorage.getItem("signupData");

        if (!rawData) {
            alert("Session expired. Please signup again.");
            window.location.href = "signup.html";
        }

        const signupData = JSON.parse(rawData);

        if (
            !signupData.name ||
            !signupData.email ||
            !signupData.password
        ) {
            alert("Invalid signup data. Please signup again.");
            sessionStorage.removeItem("signupData");
            window.location.href = "signup.html";
        }
    </script>

    <div class="auth-container">
        <h2>Verify OTP</h2>
        <p class="auth-subtitle">Enter 6-digit OTP sent to your email</p>

        <div class="otp-boxes" id="otpBoxes">
            <input maxlength="1"><input maxlength="1"><input maxlength="1">
            <input maxlength="1"><input maxlength="1"><input maxlength="1">
        </div>

        <button class="auth-btn" onclick="verifyOtp()">Verify & Create Account</button>

        <div class="resend">
            Didnâ€™t receive OTP?
            <button id="resendBtn" onclick="resendOtp()" disabled>
                Resend in <span id="timer">60</span>s
            </button>
        </div>

        <div id="msg" class="auth-message"></div>
    </div>

    <script>
        /* ================================
           OTP INPUT UX
        ================================ */
        const inputs = document.querySelectorAll(".otp-boxes input");

        inputs.forEach((input, i) => {
            input.addEventListener("input", () => {
                if (input.value && i < 5) inputs[i + 1].focus();
            });

            input.addEventListener("keydown", e => {
                if (e.key === "Backspace" && !input.value && i > 0)
                    inputs[i - 1].focus();
            });
        });

        const getOtp = () => [...inputs].map(i => i.value).join("");

        /* ================================
           RESEND OTP TIMER
        ================================ */
        let time = 60;
        const resendBtn = document.getElementById("resendBtn");

        function startTimer() {
            resendBtn.disabled = true;
            time = 60;

            const interval = setInterval(() => {
                time--;
                document.getElementById("timer").innerText = time;

                if (time <= 0) {
                    clearInterval(interval);
                    resendBtn.disabled = false;
                    resendBtn.innerText = "Resend OTP";
                }
            }, 1000);
        }
        startTimer();

        /* ================================
           RESEND OTP
        ================================ */
        async function resendOtp() {
            await fetch("http://localhost:5000/api/auth/send-otp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: signupData.email })
            });
            startTimer();
        }

        /* ================================
           VERIFY OTP (IMPORTANT)
        ================================ */
        async function verifyOtp() {
            const otp = getOtp();
            const msg = document.getElementById("msg");

            if (otp.length !== 6) {
                msg.innerText = "Enter valid 6-digit OTP";
                return;
            }

            console.log("VERIFY PAYLOAD", {
                name: signupData.name,
                email: signupData.email,
                password: signupData.password,
                otp
            });

            const res = await fetch("http://localhost:5000/api/auth/verify-otp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    name: signupData.name,
                    email: signupData.email,
                    password: signupData.password,
                    otp
                })
            });

            const data = await res.json();

            if (!data.success) {
                msg.innerText = data.message;
                return;
            }

            localStorage.setItem("token", data.token);
            localStorage.setItem("user", JSON.stringify(data.user));
            sessionStorage.removeItem("signupData");

            window.location.href = "index.html";
        }
    </script>

</body>

</html>